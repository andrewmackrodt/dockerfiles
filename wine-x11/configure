#!/bin/sh

FROM=andrewmackrodt/ubuntu

getLatestVersion() {
    docker run -i --rm --user root --entrypoint=/bin/sh "$FROM" <<'EOF'
        echo "deb https://dl.winehq.org/wine-builds/ubuntu/ $(. /etc/os-release && echo $UBUNTU_CODENAME) main" > /etc/apt/sources.list.d/wine.list
        apt-get -qq \
          -o Acquire::AllowInsecureRepositories=1 \
          -o Dir::Etc::sourcelist=/etc/apt/sources.list.d/wine.list \
          update
        apt-cache show wine-staging | grep Version | head -n1 | awk '{ print $2 }'
EOF
}

getProperties() {
    local WINE_VERSION=$(getLatestVersion)

    local LABEL_VERSION=$( \
        echo "$WINE_VERSION" \
          | sed -E 's/^([0-9]+:)?([0-9]+(\.[0-9]+)?).*/\2/'
      )

    echo "WINE_BRANCH=staging"
    echo "WINE_VERSION=$WINE_VERSION"
    echo "LABEL_VERSION=$LABEL_VERSION"
}

getProperties > build.properties
